<html>
    <head>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
<!--<script src="highcharts/js/highcharts.js"></script>-->
<script src="http://highcharts.com/js/testing.js"></script>

 <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.4/leaflet.css" />
  <script src="http://cdn.leafletjs.com/leaflet-0.4/leaflet.js"></script>
<script src="jquery.dateFormat-1.0.js"></script>


<style>
   #map { height: 50%; width: 50%; position: relative; float: left } 
#tail {
   position: relative;
   float: right;
        height: 50%;
            width: 50%;
    font-size: 12px;
}

#tailscroll{
height: 300px;
                overflow: hidden;
}
#graph_all_activity { height: 50%; position: relative; float: left; width: 50%; clear: both;}
#graph_changesets { height: 50%; width : 50%; float: right; position: relative;}
#tailtable {
    width: 100%;
}

   .leaflet-popup-content {
    font-size: 9px;
   }
</style>

    </head>

    <body>

        <script>

var currentData  = Array();
var chart_sets = undefined;
var chart_all = undefined;
var map = undefined;
var addedPoints = 0;
var markerGens = [];

var scale=10;
var chart_points = 10;
var timeOffset= 140;

var startTime = new Date().getTime();
var totalCNode = 0, totalMNode = 0, totalDNode = 0;
var totalCWay = 0, totalMWay = 0, totalDWay = 0;
var totalCRel = 0, totalMRel = 0, totalDRel = 0;
var seenUsers = Array();

function downloadAndRefreshMap() {
    $.getJSON("get-last-data.py?scale=" + scale, function(data) {
        currentData = data
    });
}

function addBestPoint() {
    var now = new Date().getTime() / 1000;
    var bestStamp = now - 140;

    if (currentData == undefined) return;
    console.log("Parsing data " + currentData["timeseries"].length);
    var bestPoint = undefined;
    var firstPoint = 99999999999, lastPoint = 0;
    for (var i in currentData["timeseries"]) {
        var thisTime = currentData["timeseries"][i]["time"]
        firstPoint = Math.min(thisTime, firstPoint)
        lastPoint = Math.max(lastPoint, thisTime)
//        console.log("Data " + currentData["timeseries"][i])
        if (currentData["timeseries"][i]["time"] > bestStamp) {
//            console.log("Trying to display " + bestStamp + " and I have " + 
//                currentData["timeseries"][i]);
            bestPoint = currentData["timeseries"][i];
            break;
        }   
    }
    if (bestPoint == undefined){
        console.log("Did not fidn data to graph " + bestStamp + " (" + new Date(bestStamp*1000) + ")");
        console.log("Found range " + firstPoint +" to " + lastPoint);
        downloadAndRefreshMap();
        setTimeout(addBestPoint, 1000);
    } else {
        var cnode = bestPoint["cnode"];
        var mnode = bestPoint["mnode"];
        var dnode = bestPoint["dnode"];
        var cway = bestPoint["cway"];
        var mway = bestPoint["mway"];
        var dway = bestPoint["dway"];
        var crel = bestPoint["crel"];
        var mrel = bestPoint["mrel"];
        var drel = bestPoint["drel"];
        totalCNode += cnode; totalMNode += mnode; totalDNode += dnode;
        totalCWay += cway; totalMWay += mway; totalDWay += dway;
        totalCRel += crel; totalMRel += mrel; totalDRel += drel;
        totalChanges = totalCNode+totalMNode+totalDNode+totalCWay+totalMWay+totalDWay+totalCRel+totalMRel+totalDRel;

        minutes = (new Date().getTime() - startTime)/60000;

        /* Draw it */
        ++addedPoints;
        {
            console.info("Setting point " + new Date(bestPoint["time"] * 1000) + " - " +  bestPoint["totalActivity"]);
            t = bestPoint["time"] * 1000;
            r =false;
            s = addedPoints > 10;
            chart_all.series[0].addPoint([t, bestPoint["cnode"]], r, s);
            chart_all.series[1].addPoint([t, bestPoint["mnode"]], r, s);
            chart_all.series[2].addPoint([t, bestPoint["dnode"]], r, s);
            chart_all.series[3].addPoint([t, bestPoint["cway"]], r, s);
            chart_all.series[4].addPoint([t, bestPoint["mway"]], r, s);
            chart_all.series[5].addPoint([t, bestPoint["dway"]], r, s);
            chart_all.series[6].addPoint([t, bestPoint["crel"]], r, s);
            chart_all.series[7].addPoint([t, bestPoint["mrel"]], r, s);
            chart_all.series[8].addPoint([t, bestPoint["drel"]], r, s);
            chart_all.redraw();
            //series.addPoint([bestPoint["time"] * 1000, bestPoint["totalActivity"]], true, addedPoints > 10);
        }
        {
            series = chart_sets.series[0];
            series.addPoint([bestPoint["time"] * 1000, bestPoint["nbChangesets"]], false, addedPoints > 10);
            chart_sets.redraw();

        }
        setTimeout(addBestPoint, scale * 1000);

        /* Draw on map */
        genMarkers = []
        for (var i in bestPoint["changesets"]) {
            var changeset = bestPoint["changesets"][i];
            console.info("Adding changeset " + changeset["minLon"]);
            var lon = (changeset["minLon"] +  changeset["maxLon"]) / 2
            var lat = (changeset["minLat"] +  changeset["maxLat"]) /2
            d =  new Date(changeset["time"] * 1000);
            var u = changeset["user"];

            if (u in seenUsers) {
            } else {
                seenUsers.push(u);
            }

            var time = $.format.date(d, "HH:mm:ss"); // d.getHours() + ":" + d.getMinutes() + ":" + d.getSeconds()
            var content = "User: " + u + " - " + time + "<br />";
            content += "cnode=" + changeset["cnode"] +  " mnode=" + changeset["mnode"] +  " dnode=" + changeset["dnode"] + "<br />";
            content += "cway=" + changeset["cway"] +  " mway=" + changeset["mway"] +  " dway=" + changeset["dway"] + "<br />";
            content += "crel=" + changeset["crel"] +  " mrel=" + changeset["mrel"] +  " drel=" + changeset["drel"] + "<br />";
//            var marker = L.popup().setLatLng([lat, lon]).setContent(content).addTo(map);
            if (changeset["minLat"] != "-90.0") {
            var marker = L.marker([lat, lon]).addTo(map);
            var poly = L.polygon([[changeset["minLat"], changeset["minLon"]],
                        [changeset["minLat"], changeset["maxLon"]],
                        [changeset["maxLat"], changeset["maxLon"]],
                        [changeset["maxLat"], changeset["minLon"]]]).addTo(map);
            genMarkers.push([marker, poly]);
            } else {
                genMarkers.push([]);
            }
            var html = "<td width=\"20%\">" + u + "</td>";//<td>" + time + "</td>";
            html += "<td>" + changeset["cnode"] +  "</td><td>" + changeset["mnode"] +  "</td><td>" + changeset["dnode"] + "</td>";
            html += "<td>" + changeset["cway"] +  "</td><td>" + changeset["mway"] +  "</td><td>" + changeset["dway"] + "</td>";
            html += "<td>" + changeset["crel"] +  "</td><td>" + changeset["mrel"] +  "</td><td>" + changeset["drel"] + "</td>";
            if (changeset["minLat"] != "-90.0") {
            html += "<td width=\"10%\"><a href=\"#\" onclick=\"var sw= new L.LatLng(" + changeset["minLat"] + "," + changeset["minLon"] + "),ne = new L.LatLng(" + changeset["maxLat"] + "," + changeset["maxLon"] + "), bounds = new L.LatLngBounds(sw, ne); map.fitBounds(bounds);\">Zoom</a></td>";
            }   else {
                html += "<td>N/A</td>";
            }
            $("<tr />").html(html).appendTo("#tailtable");
             var height = $("#tailscroll").get(0).scrollHeight;
               $("#tailscroll").animate({
                      scrollTop: height
               }, 500);

        }
        $("#summary").html("Viewing since " + minutes.toFixed(0) + "minutes, " + totalChanges + " changes by " + seenUsers.length + " users");
        
        markerGens.push(genMarkers);
        if (markerGens.length >= 5) {
            for (var i in markerGens[0]) {
                console.info("Removing 1 marker");
                for (var j in markerGens[0][i]) {
                    map.removeLayer(markerGens[0][i][j]);
                }
            }
            markerGens.reverse();
            markerGens.pop();
            markerGens.reverse();
        }
    }
}

function makeIniData() {
    data = Array()
    now = new Date().getTime();
    for (var i = 0; i < chart_points; i++) {
        data.push(0);
    }
    data.reverse()
    return data;
}


function makeOldData(now) {
    data = Array()
    for (var i = 0; i < chart_points; i++) {
        var time = now - timeOffset * 1000 - i * scale * 1000
        data.push([time, 0]);
    }
    data.reverse()
    return data;
}

$(document).ready(function() {
        Highcharts.setOptions({
            global: {
                useUTC: false
            }
        });

        downloadAndRefreshMap();
        var now = new Date().getTime();
        chart_all = new Highcharts.Chart({
            chart: {
                renderTo: 'graph_all_activity',
                type: 'area',
                marginRight: 10,
                animation : {
                    duration : 300, easing : 'linear'
                },
                events: {
                    load: function() {
// First thing very slow ...
                        setTimeout(addBestPoint, 2000);
                    }
                }
            },
            title: {
                text: 'Live edits (changes in ' + scale + 's)'
            },
            xAxis: {
                type: 'datetime',
                tickPixelInterval: 150
            },
            yAxis: {
                title: {
                    text: 'Value'
                }, min : 0,
                plotLines: [{
                    value: 0,
                    width: 1,
                    color: '#808080'
                }]
            },
            tooltip: {
                formatter: function() {
                        return '<b>'+ this.series.name +'</b><br/>'+
                        Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', this.x) +'<br/>'+
                        Highcharts.numberFormat(this.y, 2);
                }
            },
            legend: {
                enabled: true
            },
            exporting: {
                enabled: false
            },
            plotOptions : {
                area : {
                    stacking : 'normal',
                    marker : {
                        enabled : false
                    }
                }
            },
            series: [
            {name: 'Created nodes', data : makeOldData(now)},
            {name: 'Modified nodes', data : makeOldData(now)},
            {name: 'Deleted nodes', data : makeOldData(now)},
            {name: 'Created ways', data : makeOldData(now)},
            {name: 'Modified ways', data : makeOldData(now)},
            {name: 'Deleted ways', data : makeOldData(now)},
             {name: 'Created rels', data : makeOldData(now)},
            {name: 'Modified rels', data : makeOldData(now)},
            {name: 'Deleted rels', data : makeOldData(now)},
 
            ]
        });
        /*
        for (var i = 0; i < 9; i++) {
            var data = makeOldData(now);
            for (var e in data) {
                chart_all.series[i].addPoint(data[e], false, true)
            }
            chart_all.redraw();
        }*/
        chart_sets = new Highcharts.Chart({
            chart: {
                renderTo: 'graph_changesets',
                type: 'spline',
                marginRight: 10,
                animation : {
                    duration : 300, easing : 'linear'
                },
 
                events: {
                    load: function() {
// First thing very slow ...
//                        setTimeout(addBestPoint, 2000);
                    }
                }
            },
            title: {
                text: 'Live edits (changesets in ' + scale + 's)'
            },
            xAxis: {
                type: 'datetime',
                tickPixelInterval: 150
            },
            yAxis: {
                title: {
                    text: 'Value'
                }, min : 0,
                plotLines: [{
                    value: 0,
                    width: 1,
                    color: '#808080'
                }]
            },
            tooltip: {
                formatter: function() {
                        return '<b>'+ this.series.name +'</b><br/>'+
                        Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', this.x) +'<br/>'+
                        Highcharts.numberFormat(this.y, 2);
                }
            },
            legend: {
                enabled: false
            },
            exporting: {
                enabled: false
            },

            series: [{
                name: 'Changesets',
                data: (function() { return makeOldData(now);
                      var data = [];
/*                        time = (new Date()).getTime(),
                        i;
    
                    for (i = -19; i <= 0; i++) {
                        data.push({
                            x: time + (i*10) * 1000,
                            y: 0
                        });
                    }*/
                    return data;
                })()
            }]
        });

    var mapnik = new L.TileLayer(
        'http://b.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'OpenStreetMap'
        });
            var omq = new L.TileLayer(
                'http://otile2.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png', {
                    maxZoom: 14,
                    attribution: 'OpenStreetMap - MapQuest',
                    opacity: 0.4
            });
            var control = new L.Control.Layers(  { "OpenMapQuest": omq, "Mapnik": mapnik } );
             map = new L.Map('map', {
                center: new L.LatLng(0, 0),
                zoom:1,
/*                layers: [omq, mapnik]*/
            });
             map.addLayer(mapnik);
            map.addControl(control);

/*
        map = L.map('map');

          var mapnik = new L.TileLayer(
                  'http://b.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                      attribution: 'OpenStreetMap',
                });
          console.log("Adding ....");
        mapnik.addTo(map);
*/
//    map.addLayer(mapnik);
});

        </script>
    <div id="map" ></div>
    <div id="tail">
    <div id="summary"></div>
    <div id="tailhead">
    <table width="100%">
    <tr>
        <th width="20%">User</th>
        <th>cnode</th><th>mnode</th><th>dnode</th>
        <th>cway</th><th>mway</th><th>dway</th>
        <th>crel</th><th>mrel</th><th>drel</th>
        <th width="10%">Link</th>
        </tr>
        </table>
 
    </div>
    <div id="tailscroll">
    <table id="tailtable">
    <!--<tr>
        <th>User</th><th>Time</th>
        <th>cnode</th><th>mnode</th><th>dnode</th>
        <th>cway</th><th>mway</th><th>dway</th>
        <th>crel</th><th>mrel</th><th>drel</th>
        <th>link</th>
        </tr>
        -->
        </table>
    </div>
    </div>
    <div id="graph_all_activity" ></div>
    <div id="graph_changesets" ></div>
    </body>
</html>
